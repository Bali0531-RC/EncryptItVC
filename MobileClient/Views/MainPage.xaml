<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="EncryptItVC.MobileClient.Views.MainPage"
             Title="Voice Chat"
             BackgroundColor="{StaticResource DarkBackground}">

    <Grid RowDefinitions="Auto,*,Auto,Auto">
        
        <!-- Header with Connection Status -->
        <Frame Grid.Row="0" 
               BackgroundColor="{StaticResource Primary}" 
               BorderColor="Transparent"
               CornerRadius="0"
               Padding="20,10">
            <Grid ColumnDefinitions="*,Auto">
                <StackLayout Grid.Column="0" Orientation="Horizontal" Spacing="10">
                    <Label Text="Connected to:" 
                           TextColor="White" 
                           VerticalOptions="Center"/>
                    <Label Text="{Binding ServerName}" 
                           TextColor="{StaticResource Tertiary}" 
                           FontAttributes="Bold"
                           VerticalOptions="Center"/>
                </StackLayout>
                
                <Label Grid.Column="1" 
                       Text="{Binding ConnectionStatus}"
                       TextColor="{Binding IsConnected, Converter={StaticResource BoolToColorConverter}}"
                       FontSize="12"
                       VerticalOptions="Center"/>
            </Grid>
        </Frame>
        
        <!-- Main Content Area -->
        <Grid Grid.Row="1" ColumnDefinitions="*,*">
            
            <!-- Channels List -->
            <Frame Grid.Column="0" 
                   BackgroundColor="{StaticResource Secondary}" 
                   BorderColor="Transparent"
                   CornerRadius="10"
                   Margin="10,5,5,5"
                   Padding="15">
                <StackLayout>
                    <Label Text="Channels" 
                           FontSize="16" 
                           FontAttributes="Bold"
                           TextColor="White"
                           Margin="0,0,0,10"/>
                    
                    <CollectionView ItemsSource="{Binding Channels}"
                                    SelectedItem="{Binding SelectedChannel}"
                                    SelectionMode="Single">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="5" BackgroundColor="Transparent">
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.JoinChannelCommand}" 
                                                              CommandParameter="{Binding}"/>
                                    </Grid.GestureRecognizers>
                                    
                                    <StackLayout Orientation="Horizontal" Spacing="10">
                                        <Label Text="#" 
                                               TextColor="{StaticResource Tertiary}" 
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"/>
                                        <Label Text="{Binding Name}" 
                                               TextColor="White"
                                               VerticalOptions="Center"/>
                                        <Label Text="{Binding UserCount, StringFormat='({0} users)'}" 
                                               TextColor="{StaticResource Gray300}" 
                                               FontSize="12"
                                               VerticalOptions="Center"/>
                                    </StackLayout>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                    
                    <Button Text="Create Channel" 
                            Command="{Binding CreateChannelCommand}"
                            BackgroundColor="{StaticResource Tertiary}"
                            Margin="0,10,0,0"/>
                </StackLayout>
            </Frame>
            
            <!-- Users List -->
            <Frame Grid.Column="1" 
                   BackgroundColor="{StaticResource Secondary}" 
                   BorderColor="Transparent"
                   CornerRadius="10"
                   Margin="5,5,10,5"
                   Padding="15">
                <StackLayout>
                    <Label Text="Users in Channel" 
                           FontSize="16" 
                           FontAttributes="Bold"
                           TextColor="White"
                           Margin="0,0,0,10"/>
                    
                    <CollectionView ItemsSource="{Binding UsersInChannel}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="5" BackgroundColor="Transparent">
                                    <StackLayout Orientation="Horizontal" Spacing="10">
                                        <!-- Voice Status Indicator -->
                                        <Frame BackgroundColor="{Binding VoiceStatus, Converter={StaticResource VoiceStatusToColorConverter}}"
                                               WidthRequest="12" 
                                               HeightRequest="12"
                                               CornerRadius="6"
                                               Padding="0"
                                               VerticalOptions="Center"/>
                                        
                                        <Label Text="{Binding Username}" 
                                               TextColor="White"
                                               VerticalOptions="Center"/>
                                        
                                        <!-- Admin Crown -->
                                        <Label Text="ðŸ‘‘" 
                                               IsVisible="{Binding IsAdmin}"
                                               VerticalOptions="Center"/>
                                    </StackLayout>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>
            </Frame>
        </Grid>
        
        <!-- Chat Area -->
        <Frame Grid.Row="2" 
               BackgroundColor="{StaticResource Secondary}" 
               BorderColor="Transparent"
               CornerRadius="10"
               Margin="10,5"
               Padding="15"
               HeightRequest="200">
            <Grid RowDefinitions="Auto,*,Auto">
                <Label Grid.Row="0" 
                       Text="Chat" 
                       FontSize="16" 
                       FontAttributes="Bold"
                       TextColor="White"
                       Margin="0,0,0,10"/>
                
                <CollectionView Grid.Row="1" 
                                ItemsSource="{Binding ChatMessages}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid Padding="2">
                                <Label Text="{Binding ., StringFormat='[{0:HH:mm}] {1}: {2}'}" 
                                       TextColor="White"
                                       FontSize="12"/>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
                <Grid Grid.Row="2" ColumnDefinitions="*,Auto" ColumnSpacing="10">
                    <Entry Grid.Column="0" 
                           Text="{Binding NewMessage}"
                           Placeholder="Type a message..."
                           ReturnType="Send"
                           ReturnCommand="{Binding SendMessageCommand}"/>
                    
                    <Button Grid.Column="1" 
                            Text="Send"
                            Command="{Binding SendMessageCommand}"
                            BackgroundColor="{StaticResource Tertiary}"/>
                </Grid>
            </Grid>
        </Frame>
        
        <!-- Voice Controls -->
        <Frame Grid.Row="3" 
               BackgroundColor="{StaticResource Primary}" 
               BorderColor="Transparent"
               CornerRadius="0"
               Padding="20">
            <Grid ColumnDefinitions="*,*,*,*">
                
                <!-- Microphone Toggle -->
                <Button Grid.Column="0" 
                        Text="{Binding IsMuted, Converter={StaticResource BoolToMuteTextConverter}}"
                        Command="{Binding ToggleMuteCommand}"
                        BackgroundColor="{Binding IsMuted, Converter={StaticResource BoolToMuteColorConverter}}"
                        FontSize="12"/>
                
                <!-- Deafen Toggle -->
                <Button Grid.Column="1" 
                        Text="{Binding IsDeafened, Converter={StaticResource BoolToDeafenTextConverter}}"
                        Command="{Binding ToggleDeafenCommand}"
                        BackgroundColor="{Binding IsDeafened, Converter={StaticResource BoolToDeafenColorConverter}}"
                        FontSize="12"/>
                
                <!-- Push to Talk -->
                <Button Grid.Column="2" 
                        Text="Push to Talk"
                        Command="{Binding PushToTalkCommand}"
                        BackgroundColor="{StaticResource VoiceActive}"
                        FontSize="12"/>
                
                <!-- Voice Settings -->
                <Button Grid.Column="3" 
                        Text="Settings"
                        Command="{Binding VoiceSettingsCommand}"
                        BackgroundColor="{StaticResource Gray600}"
                        FontSize="12"/>
            </Grid>
        </Frame>
    </Grid>
    
</ContentPage>
